function ElementTiming(e,t){this.elementId=e;this.times=t;this.beats=[];this.addBeat=function(e){if(this.beats.length<this.times){this.beats[this.beats.length]=e;console.log(this.beats.length+" beat on "+e+" ("+this.elementId+")");return true}else{return false}};this.getAverageBeatTime=function(e){var t=this.beats.map(function(e,t,n){if(t==n.length-1){return 0}else{return n[t+1]-e}});var n=t.reduce(function(e,t){return e+t},0);return n/(this.times-1)};this.getBeginTime=function(){var e=this.beats[0]-this.getAverageBeatTime();if(!e){e=this.beats[0]}e=Math.round(e*10)/10;return e}}function TimingGenerator(){this.getElementsList=function(){function t(t,n){e[e.length]={id:t,times:n}}var e=[];var n=document.getElementById("schema");if("contentDocument"in n){var r=jQuery(n.contentDocument);var i=0;var s=1;$("rect.element",r).each(function(e,n){if(n.attributes.y.value!=i){i=n.attributes.y.value;if(s!=1){t("#pause_"+s,1)}t("#start_"+s,1);s+=1}t(n.id,n.dataset.times)});t("#end",1);return e}};this.elementsList=this.getElementsList();console.log(this.elementsList);this.elementsTiming=[];this.currentElementIndex=0;this.lastTimeValue=0;this.clear=function(){this.elementsTiming=[];this.currentElementIndex=0;this.lastTimeValue=0};this.addBeat=function(e){if(this.currentElementIndex>=this.elementsList.length){console.log("finish");return false}var t=this.elementsList[this.currentElementIndex];if(this.currentElementIndex>=this.elementsTiming.length){this.elementsTiming[this.elementsTiming.length]=new ElementTiming(t.id,t.times);markCurrentElementOnSchema(t.id)}if(!this.elementsTiming[this.elementsTiming.length-1].addBeat(e)){this.currentElementIndex+=1;this.addBeat(e)}return true};this.getTiming=function(){var e={};for(var t=0;t<this.elementsTiming.length;t++){e[this.elementsTiming[t].elementId]=this.elementsTiming[t].getBeginTime()}return e}}jQuery.fn.myAddClass=function(e){return this.each(function(){var t=jQuery(this).attr("class");t=t?t:"";var n=t.indexOf(e);if(n>=0)return;jQuery(this).attr("class",(t+" "+e).trim())})};jQuery.fn.myRemoveClass=function(e){return this.each(function(){var t=jQuery(this).attr("class");var n=t.indexOf(e);if(n<0)return;var r=n+e.length;var i=t.substring(0,n).trim()+" "+t.substring(r).trim();if(!i.trim())jQuery(this).removeAttr("class");else jQuery(this).attr("class",i.trim())})};jQuery.fn.myHasClass=function(e){return jQuery(this).first().attr("class").indexOf(e)>=0};var playerId="jplayer";var playerSelector="#"+playerId;var mod=function(e,t){divVal=e/t;modVal=divVal-Math.floor(divVal);return modVal};var getSvgSchemaDom=function(){var e=document.getElementById("schema");if("contentDocument"in e){var t=jQuery(e.contentDocument);return t}else{return false}};var hideCurrentElementMarkOnSchema=function(e){if(!e){e=getSvgSchemaDom()}$("rect",e).myRemoveClass("current");$("text",e).myRemoveClass("current")};var hideCurrentElement=function(e){hideCurrentElementMarkOnSchema();$.animation.clear();$(playerSelector).data("currentElement","")};var markCurrentElementOnSchema=function(e,t){if(!t){t=getSvgSchemaDom()}if(e[0]=="#"){return}var n=e+"-frame";$("rect:not(#"+n+")",t).myRemoveClass("current");$("#"+n,t).myAddClass("current");var r=e+"-text";$("text:not(#"+r+")",t).myRemoveClass("current");$("#"+r,t).myAddClass("current")};var showCurrentElement=function(e,t,n){if(!n){n=getSvgSchemaDom()}if(e.split("_")[0]=="#start"){$.animation.setAtStart();hideCurrentElementMarkOnSchema();return}else if(e[0]=="#"){return}markCurrentElementOnSchema(e,n);var r=$("#"+e,n);var i=r.data("visualization");var s=r.data("manposition");var o=r.data("times");if(i){$.animation[i](t,s,o)}};var initSvgSchema=function(){var e=getSvgSchemaDom();if(e){$("#schema").attr("width",$("svg",e).attr("width")).attr("height",$("svg",e).attr("height"));var t=function(e){return function(t){if(t.jPlayer.status.paused&&t.jPlayer.status.currentTime==0){hideCurrentElement(e)}else if(!t.jPlayer.status.paused){$.animation.resume();var n=t.jPlayer.status.currentTime;var r=getElement(n);if($(playerSelector).data("currentElement")!=r["name"]){$(playerSelector).data("currentElement",r["name"]);if(r&&r["name"].length>0){showCurrentElement(r["name"],r["timeLength"],e)}}}}}(e);var n=function(e){return function(t){hideCurrentElement(e)}}(e);var r=function(e){return function(e){if(e.jPlayer.status.paused&&e.jPlayer.status.currentTime>0){$.animation.pause()}}}(e);$(playerSelector).bind($.jPlayer.event.timeupdate,t).bind($.jPlayer.event.ended,n).bind($.jPlayer.event.pause,r)}};var initSvgSchemaEditor=function(){var e=getSvgSchemaDom();if(e){$("#schema").attr("width",$("svg",e).attr("width")).attr("height",$("svg",e).attr("height"))}};var getAnimationClassDef=function(e,t){for(var n=0;n<e.length;n++){if(t===e[n].id){return e[n]}}return e[0]};var showAnimationLinks=function(e,t){var n=getAnimationClassDef(e,t);var r=function(e){var t="";for(var r=0;r<e.length;r++){if(e[r].id===n.id){t+=i18n.t(e[r].title)}else{t+="<a href=\"javascript:showAnimation('"+e[r].id+'\')" data-i18n="'+e[r].title+'">'+i18n.t(e[r].title)+"</a>"}if(r<e.length-1){t+=", "}}return t};$("#animationLinks").html(r(e))};var showMusicLinks=function(e,t){if(e.length<=1){$("#musicLinks").html("");return}var n=function(){var n='Composition: <select id="musicSelect">';for(var r=0;r<e.length;r++){if(e[r]===t){n+='<option selected="selected" value="'+e[r]+'">'+music.get(e[r]).title+"</option>"}else{n+='<option value="'+e[r]+'">'+music.get(e[r]).title+"</option>"}}n+="</select>";return n};$("#musicLinks").html(n());$("#musicSelect").change(function(){showMusic($(this).val())})};var showLanguageLinks=function(){var e=[{id:"ru",title:"ru"},{id:"en",title:"en"}];var t=function(){var t="<nobr>";for(var n=0;n<e.length;n++){if(e[n].id==i18n.lng()){t+=e[n].title}else{t+='<a href="'+getLanguageLink(e[n].id)+'">'+e[n].title+"</a>"}if(n<e.length-1){t+=" / "}}t+="</nobr>";return t};$("#lang").html(t())};var loadAnimation=function(e){$.animation=new window[e]("animation");$("#animation").attr("width",$.animation.width).attr("height",$.animation.height).attr("viewBox","0 0 "+$.animation.width+" "+$.animation.height)};var loadSchema=function(e,t,n,r,i,s){$("#danceName").html(e);$("#schemaDiv").html('<object data="svg/'+t+'.svg" type="image/svg+xml" id="schema"></object>');$("#animationDiv").html('<svg id="animation" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>');if(typeof i==="object"){showAnimationLinks(i,s);var o=getAnimationClassDef(i,s);i=o.name}else{$("#animationLinks").html("")}r=r?r:n[0];showMusicLinks(n,r);var u=music.get(r);var a=document.getElementById("schema");$(a).load(function(){$(playerSelector).unbind($.jPlayer.event.timeupdate).unbind($.jPlayer.event.ended).unbind($.jPlayer.event.pause);loadMusicSchema(u);initSvgSchema();loadAnimation(i)})};var loadSchemaEditor=function(e,t,n,r){$("#danceName").html(e+" (editor mode)");$("#schemaDiv").html('<object data="svg/'+t+'.svg" type="image/svg+xml" id="schema"></object>');var i=document.getElementById("schema");$(i).load(function(){$(playerSelector).unbind($.jPlayer.event.timeupdate).unbind($.jPlayer.event.ended).unbind($.jPlayer.event.pause);showMusicLinks(n,r);var e=music.get(r);loadMusicSchema(e);initSvgSchemaEditor();console.log("editor mode on");$("#animationDiv").html("");var t=$(playerSelector).data("schema");var i=new TimingGenerator(t);var s=function(e){return function(t){if(t.jPlayer.status.paused&&t.jPlayer.status.currentTime==0){hideCurrentElementMarkOnSchema();e.clear()}}}(i);$(playerSelector).bind($.jPlayer.event.timeupdate,s);$("html").keypress(function(e){if(e.which==32){var t=$(playerSelector).data("jPlayer").status.currentTime;if(!i.addBeat(t)){var n=i.getTiming();$("#animationDiv").html("<pre>"+JSON.stringify(n,"",4)+"</pre>")}}})})};var schemaParamsMap={Zamba:{name:"Zamba",svgName:"zamba",music:["zamba"],animation:[{id:"classic",name:"ZambaAnimation",title:"animation_links.common"},{id:"simple",name:"ZambaSimpleAnimation",title:"animation_links.simple"}]},Gato:{name:"Gato",svgName:"gato",music:["gato"],animation:"GatoAnimation"},Caramba:{name:"Caramba",svgName:"caramba",music:["caramba"],animation:"GatoAnimation"},Chacarera:{name:"Chacarera",svgName:"chacarera",music:["chacarera"],animation:[{id:"onTwo",name:"ChacareraAnimation",title:"animation_links.two_people"},{id:"onFour",name:"Chacarera4Animation",title:"animation_links.four_people"}]},Chacarera6:{name:"Chacarera on 6",svgName:"chacarera_6",music:["chacarera_6"],animation:[{id:"onTwo",name:"ChacareraAnimation",title:"animation_links.two_people"},{id:"onFour",name:"Chacarera4Animation",title:"animation_links.four_people"}]},ChacareraDoble:{name:"Chacarera doble",svgName:"chacarera_doble",music:["chacarera_doble_el_olvidao","chacarera_doble_sombra_enamorada"],animation:[{id:"onTwo",name:"ChacareraAnimation",title:"animation_links.two_people"},{id:"onFour",name:"Chacarera4Animation",title:"animation_links.four_people"}]},ChacareraDoble6:{name:"Chacarera doble on 6",svgName:"chacarera_doble_6",music:["chacarera_doble_6_pampa_de_los_guanacos"],animation:[{id:"onTwo",name:"ChacareraAnimation",title:"animation_links.two_people"},{id:"onFour",name:"Chacarera4Animation",title:"animation_links.four_people"}]},Bailecito:{name:"Bailecito",svgName:"bailecito",music:["bailecito"],animation:"BailecitoAnimation"},Escondido:{name:"Escondido",svgName:"escondido",music:["escondido"],animation:"EscondidoAnimation"},Remedio:{name:"Remedio",svgName:"remedio",music:["remedio"],animation:"RemedioAnimation"},RemedioAtamisqueno:{name:"Remedio Atamisqueno",svgName:"remedio_atamisqueno",music:["remedio_atamisqueno"],animation:"RemedioAnimation"}};var loadSchemaByName=function(e,t,n){var r=schemaParamsMap[e];if(!r){r=schemaParamsMap.Chacarera}loadSchema(r.name,r.svgName,r.music,n,r.animation,t);showLanguageLinks()};var loadSchemaEditorByName=function(e,t){var n=schemaParamsMap[e];if(!n){n=schemaParamsMap.Chacarera}loadSchemaEditor(n.name,n.svgName,n.music,t);showLanguageLinks()};var getLanguageLink=function(e){var t=new URI;var n=t.query(true);n.lang=e;var r=URI.buildQuery(n);return t.query(r).build()};var showSchema=function(e){History.pushState({schema:e},e+" schema","?schema="+e)};var showAnimation=function(e){var t=new URI;var n=t.query(true);History.pushState({schema:n.schema,animationId:e,musicId:n.musicId},name+" - Adentro","?schema="+n.schema+"&animationId="+e+(n.musicId?"&musicId="+n.musicId:""));var r=schemaParamsMap[n.schema];var i=r.animation;var s=getAnimationClassDef(i,e);var o=s.name;loadAnimation(o);showAnimationLinks(i,e);showLanguageLinks()};var showMusic=function(e){var t=new URI;var n=t.query(true);History.pushState({schema:n.schema,animationId:n.animationId,musicId:e},name+" - Adentro","?schema="+n.schema+(n.animationId?"&animationId="+n.animationId:"")+"&musicId="+e);var r=schemaParamsMap[n.schema];var i=r.music;var s=music.get(e);loadMusicSchema(s);showMusicLinks(i,e);showLanguageLinks()};var loadSchemaByState=function(){var e=History.getState();if(e.data&&e.data.schema){loadSchemaByName(e.data.schema);return true}return false};var loadSchemaByUrl=function(){var e=new URI;var t=e.query(true);if(t.schema){if(t.editor){loadSchemaEditorByName(t.schema,t.musicId)}else{loadSchemaByName(t.schema,t.animationId,t.musicId)}return true}return false};var playerId="jplayer";var playerSelector="#"+playerId;var loadMusicSchema=function(e){$(playerSelector).jPlayer("setMedia",{title:e.title,mp3:e.file});$(playerSelector).data("schema",e.schema)};var getElement=function(e){schema=$(playerSelector).data("schema");var t={name:"",time:-1};jQuery.each(schema,function(n,r){if(e-r>=0&&e-r<e-t["time"]){t["name"]=n;t["time"]=r}});var n={name:"",time:1e4};jQuery.each(schema,function(e,r){if(r-t["time"]>0&&r-t["time"]<n["time"]-t["time"]){n["name"]=e;n["time"]=r;t["timeLength"]=n["time"]-t["time"]}});return t};var playElement=function(e){schema=$(playerSelector).data("schema");time=schema[e];$.animation.clear();$(playerSelector).jPlayer("play",time)};var music=[{id:"gato",title:"Chaqueño Palavecino - Gatito Pa' Don Lucas",file:"./music/gato/gatito_pa_don_lucas.mp3",schema:{"#start_1":3.2,vuelta:9.7,giro:17.9,zapateo:22.2,mediaVuelta:30.6,zapateo2:34.5,coronacion:42.9,"#pause_2":46.5,"#start_2":50.6,vuelta_2:55.4,giro_2:63.6,zapateo_2:67.7,mediaVuelta_2:76.3,zapateo2_2:80.3,coronacion_2:88.5,"#end":93.8}},{id:"caramba",title:"Caramba",file:"./music/caramba/none.mp3",schema:{"#start":2,giro:10.7,contraGiro:15,mediaVuelta:19,giro2:23,contraGiro2:27,giro3:31,mediaVuelta2:35,giro4:39,mediaVuelta3:42,coronacion:45,"#p":47.5,"#start_2":49,giro_2:56.6,contraGiro_2:60,mediaVuelta_2:64.7,giro2_2:69,contraGiro2_2:77,giro3_2:79,mediaVuelta2_2:81.4,giro4_2:85.4,mediaVuelta3_2:87,coronacion_2:90,"#e":93}},{id:"chacarera",title:"La pockoy y pancha",file:"./music/chacarera/la_pockoy_y_pancha.mp3",schema:{"#start_1":2.6,avance:8.1,giro:12.3,vuelta:16.8,zapateo:25.4,vuelta2:33.9,zapateo2:42.4,mediaVuelta:50.9,coronacion:55.2,"#pause_2":60,"#start_2":63,avance_2:69.2,giro_2:73.5,vuelta_2:77.7,zapateo_2:86.5,vuelta2_2:95,zapateo2_2:103.6,mediaVuelta_2:112.1,coronacion_2:116.3,"#end":121}},{id:"chacarera_6",title:"La Penadora",file:"./music/chacarera_6/la_penadora.mp3",schema:{"#start_1":1.1,avance:10.6,giro:15.7,vuelta:20.5,zapateo:27.5,vuelta2:37.3,zapateo2:44.3,mediaVuelta:54.1,coronacion:58.8,"#pause_2":64,"#start_2":67.6,avance_2:77,giro_2:81.4,vuelta_2:86.4,zapateo_2:93.5,vuelta2_2:103.3,zapateo2_2:110.5,mediaVuelta_2:120.1,coronacion_2:124.8,"#end":130}},{id:"chacarera_doble_el_olvidao",title:"Nestor Garnica - El olvidao",file:"./music/chacarera_doble/el_olvidao.mp3",schema:{"#start_1":3.6,avance:19.3,avance2:23.7,giro:27.9,vuelta:32.2,zapateo:40.7,giro2:49.2,vuelta2:53.2,zapateo2:61.5,giro3:70.3,mediaVuelta:74.3,zapateo3:78.6,coronacion:82.6,"#pause_2":87,"#start_2":89.6,avance_2:104.3,avance2_2:108.7,giro_2:112.9,vuelta_2:116.9,zapateo_2:125.4,giro2_2:133.7,vuelta2_2:138,zapateo2_2:146.5,giro3_2:154.7,mediaVuelta_2:159.1,zapateo3_2:163.1,coronacion_2:167,"#end":171.4}},{id:"chacarera_doble_sombra_enamorada",title:"Chaqueño Palavecino - Sombra Enamorada",file:"./music/chacarera_doble/sombra_enamorada.mp3",schema:{"#start_1":4.2,avance:12.8,avance2:17.5,giro:22,vuelta:26.8,zapateo:35.8,giro2:45.3,vuelta2:49.8,zapateo2:59.4,giro3:68.4,mediaVuelta:73.2,zapateo3:78,coronacion:82.4,"#pause_2":87.4,"#start_2":91.4,avance_2:101.7,avance2_2:106.2,giro_2:111,vuelta_2:115.5,zapateo_2:124.7,giro2_2:134,vuelta2_2:138.8,zapateo2_2:148.1,giro3_2:157.4,mediaVuelta_2:161.8,zapateo3_2:166.6,coronacion_2:171.1,"#end":176.3}},{id:"chacarera_doble_6_pampa_de_los_guanacos",title:"Los Reynoso - Pampa de los guanacos",file:"./music/chacarera_doble_6/pampa_de_los_guanacos.mp3",schema:{"#start_1":1.9,avance:10,avance2:14.6,giro:18.8,vuelta:23.4,zapateo:29.6,giro2:38.3,vuelta2:42.9,zapateo2:49.4,giro3:58.2,mediaVuelta:62.4,zapateo3:67,coronacion:71.2,"#pause_2":75.8,"#start_2":77.8,avance_2:87.5,avance2_2:92,giro_2:96.3,vuelta_2:100.5,zapateo_2:107,giro2_2:115.8,vuelta2_2:120,zapateo2_2:126.6,giro3_2:135.3,mediaVuelta_2:139.6,zapateo3_2:143.8,coronacion_2:148.4,"#end":153}},{id:"chacarera_doble_6_anorazas",title:"Anorazas",file:"./music/chacarera_doble_6/anorazas.mp3",schema:{}},{id:"bailecito",title:"Abel Figueroa - Toda la noche",file:"./music/bailecito/toda_la_noche.mp3",schema:{"#start_1":1.3,avance:14.5,retroceso:19,avance2:23.3,retroceso2:27.8,giro:32.1,contraGiro:36.5,mediaVuelta:40.8,coronacion:45.3,"#pause_2":49.7,"#start_2":52.4,avance_2:66.1,retroceso_2:70.7,avance2_2:74.9,retroceso2_2:79.4,giro_2:83.6,contraGiro_2:88.2,mediaVuelta_2:92.7,coronacion_2:96.9,"#pause_3":101.6,"#start_3":103.5,avance_3:118.2,retroceso_3:122.7,avance2_3:127,retroceso2_3:131.5,giro_3:135.7,contraGiro_3:140.3,mediaVuelta_3:144.8,coronacion_3:149,"#end":153.8}},{id:"escondido",title:"Tamara Castro - Huaico Hondo",file:"./music/escondido/huaico_hondo.mp3",schema:{"#start_1":.9,esquina1:9.8,esquina2:14.1,esquina3:18.4,esquina4:22.7,vuelta:26.6,zapateo:35.2,vuelta2:43.4,zarandeo:52,mediaVuelta:60.2,coronacion:64.4,"#pause_2":69,"#start_2":71,esquina1_2:79.6,esquina2_2:83.5,esquina3_2:87.8,esquina4_2:92,vuelta_2:96.3,zarandeo_2:104.6,vuelta2_2:112.9,zapateo_2:121.4,mediaVuelta_2:130,coronacion_2:134.2,"#end":138.6}},{id:"remedio",title:"Remedio Norteno",file:"./music/remedio/remedio_norteno.mp3",schema:{"#start_1":1.4,esquina1:9.1,esquina2:13.3,esquina3:17.9,esquina4:22.1,vuelta:26.7,zapateoZarandeo:35.4,vuelta2:44.2,zapateoZarandeo2:52.9,mediaVuelta:62,coronacion:66.2,"#pause_2":71,"#start_2":74.9,esquina1_2:82.6,esquina2_2:87.1,esquina3_2:91.6,esquina4_2:95.9,vuelta_2:100.3,zapateoZarandeo_2:109.3,vuelta2_2:117.9,zapateoZarandeo2_2:126.9,mediaVuelta_2:135.4,coronacion_2:140,"#end":144.8}},{id:"remedio_atamisqueno",title:"Waldo Belloso - Remedio Atamisqueno",file:"./music/remedio_atamisqueno/remedio_atamisqueno.mp3",schema:{"#start_1":1.4,esquina1:9.1,esquina2:13.3,esquina3:17.9,esquina4:22.1,vuelta:26.7,zapateoZarandeo:35.4,vuelta2:44.2,zapateoZarandeo2:52.9,mediaVuelta:62,coronacion:66.2,"#pause_2":71,"#start_2":74.9,esquina1_2:82.6,esquina2_2:87.1,esquina3_2:91.6,esquina4_2:95.9,vuelta_2:100.3,zapateoZarandeo_2:109.3,vuelta2_2:117.9,zapateoZarandeo2_2:126.9,mediaVuelta_2:135.4,coronacion_2:140,"#end":144.8}},{id:"zamba",title:"Zamba",file:"./music/zamba/el_beso.mp3",schema:{"#start_1":2,vuelta:16.4,arresto:31.4,mediaVuelta:39.1,arrestoDoble:46.5,mediaVuelta2:61.6,arresto2:69.2,mediaVueltaCoronacion:77,"#pause_2":83.7,"#start_2":88.3,vuelta_2:101.5,arresto_2:116.5,mediaVuelta_2:124.2,arrestoDoble_2:131.9,mediaVuelta2_2:146.9,arresto2_2:154.7,mediaVueltaCoronacion_2:162,"#end":168.3}}];music.get=function(e){for(var t=0;t<music.length;t++){if(music[t].id===e){return music[t]}}console.error("Èíôîðìàöèÿ î êîìïîçèöèè "+e+" íå íàéäåíà")};var tour=function(){return{id:"adentro_tour",steps:[{title:i18n.t("tour.navigation_title"),content:i18n.t("tour.navigation"),target:"#navigation>li",zindex:9999,placement:"bottom"},{title:i18n.t("tour.player_title"),content:i18n.t("tour.player"),target:"jp_container_1",zindex:9999,placement:"right"},{title:i18n.t("tour.music_title"),content:i18n.t("tour.music"),target:"#musicLinks>select",zindex:9999,placement:"right"},{title:i18n.t("tour.schema_title"),content:i18n.t("tour.schema"),target:"schemaDiv",zindex:9999,xOffset:"center",yOffset:-50,placement:"bottom"},{title:i18n.t("tour.animation_title"),content:i18n.t("tour.animation"),target:"animationDiv",zindex:9999,xOffset:"center",placement:"top"},{title:i18n.t("tour.animation_links_title"),content:i18n.t("tour.animation_links"),target:"#animationLinks>a",zindex:9999,xOffset:"center",placement:"bottom"}]}}